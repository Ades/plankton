<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Plankan timer</title>

    <link rel="stylesheet" type="text/css" href="plankton.css">

    <script type="text/javascript" src="howler.js/howler.min.js"></script>
    <script type="text/javascript" src="scripts/prototype.js"></script>
    <script type="text/javascript" src="scripts/utils.js"></script>
    <script type="text/javascript">
        var tickSound = 'tick.mp3';

        var countdownParts = [
            {
                time: -3,
                type: 'speak',
                sound: 'Three!'
            },
            {
                time: -2,
                type: 'speak',
                sound: 'Two!'
            },
            {
                time: -1,
                type: 'speak',
                sound: 'One!'
            },
            {
                time: null,
                type: 'file',
                sound: 'Intercom-beep-sound.mp3'
            }
        ];

        var cheerfulPhrases = [
            'Keep on!', 'Good work!', 'Be strong!', 'Live long and prosper.', 'All is well.', 'Remain cheerful!',
            'Be positive.', 'Stay happy', 'Hakuna matata!', 'The greatest wealth is health.', 'Eat right, exercise regularly',
            'Health is happiness.', 'A good laugh and a long sleep are the best cures in the doctor\'s book.', 'Boom, shackalacka, boom!',
            'Be yourself', 'Alive and kicking.', 'Refuse to lose.', 'Attitude is everything.', 'Don\'t worry, be happy.',
            'Yes you can.', 'No worries.', 'Get the ball rolling.', 'No guts, no glory.', 'Impossible is nothing.', 'Impossibru', 'Play hard or go home.',
            'Success is the only option.',

            'If you’re one in a million, there are more than seven thousand people exactly like you.',
            'Light travels faster than sound. This is why some people appear bright until they speak.',
            'Be Happy, stop complaining.',
            'Wow, you guys will be ripped after all of these Planks',
            'we will. we will. rock you'
        ];

        var enabledJokes = [];

        var shortJokes = [
            ['What happens to a frog\'s car when it breaks down?', 'It gets toad away.'],
            ['What is the difference between snowmen and snowwomen?', 'Snowballs.'],
            'I never wanted to believe that my Dad was stealing from his job as a road worker. But when I got home, all the signs were there.',
            ['How do astronomers organize a party?', 'They planet.'],
            ['What did the blanket say when it fell of the bed?', 'Oh sheet!'],
            ['Can a kangaroo jump higher than the Empire State Building?', 'Of course. The Empire State Building can\'t jump.'],
            'If you ever get cold, just stand in the corner of a room for a while. They\'re normally around 90 degrees.',
            ['What is Mozart doing right now?', 'Decomposing.'],
            'A drunk walks into a bar with jumper cables around his neck. The bartender says, "You can stay but don\'t try to start anything."',
            ['What’s the best thing about Switzerland?', 'I don\'t know, but the flag is a big plus.'],
            ['Two men broke into a drugstore and stole all the Viagra.', 'The police put out an alert to be on the lookout for the two hardened criminals.'],
            ['How do you embarrass an archaeologist? Show him a used tampon and ask, "What period is this from?"'],
            ['What kind of car does Jesus drive?', 'A Christ-leur.'],
            ['What do you call a midget psychic who just escaped from prison?', 'A small medium at large.'],
            ['A neutron walks into a bar and says', 'I\'d like a beer. How much will that be?', 'The bartender responds', 'For you? No charge!'],
            ['To the optimist, the glass is half full.', 'To the pessimist, the glass is half empty.', 'To the engineer, the glass is twice as big as it needs to be.'],
            ['What\'s the difference between America and yogurt?', 'If you leave yogurt alone for 200 years, it develops a culture.'],
            ['What did the spider do on the computer?', 'Made a website!'],
            ['What do you get when you cross a donkey and an onion?', 'A piece of ass that\'ll bring a tear to your eye.'],
            ['What did the pony say when he had a sore throat?', 'Sorry, I\'m a little horse.'],
            ['What do you call someone without a nose or a body?', 'Nobody nose.'],
            ['Why did the condom fly across the room?', 'Because it was pissed off.'],
            ['What do you give a deaf fisherman?', 'A herring aid.'],
            ['What do the starship Enterprise and toilet paper have in common?', 'They both probe Uranus and wipe out Klingons.'],
            'I never forget a face, but in your case I\'ll be glad to make an exception.',
            'I totally understand how batteries feel because I\'m rarely ever included in things either.',
            'Did you hear about the Mexican train killer? He had locomotives.',
            ['What time is it when you have to go to the dentist?', 'Tooth-hurtie.'],
            ['Why can’t a bike stand on its own?', 'It’s two tired.'],
            ['Last night I almost had a threesome.', 'I only needed two more people!'],
            'Atheism is a non-prophet organization.',
            'When you get a bladder infection, urine trouble.',
            ['I wrote a song about a tortilla.', 'Well actually, it’s more of a wrap.'],
            ['A roman legionnaire walks into a bar, holds up two fingers and says', '"Five beers, please.'],
            ['I started a band called ninehundred ninety nine Megabytes', 'we haven’t gotten a gig yet.'],
            'Dwarfs and midgets have very little in common.',
            ['Two cannibals are eating a clown.', 'One says to the other.', '"Does this Taste funny to you?"'],
            ['Did you hear about the guy who died of a Viagra overdose?', 'They couldn\'t close his casket.'],
            ['How did Burger King get Dairy Queen Pregnant?', 'He forgot to wrap his whopper!'],
            ['Definition of a bachelor:', 'A man who has missed the opportunity to make some woman miserable.'],
            'How does a man take a bubble bath? He eats beans for dinner.',
            ['How do men sort out their laundry?', 'Filthy', 'And filthy but wearable.'],
            ['What\'s in the toilet of the star ship enterprise?', 'The captains log.'],
            ['Have you ever tried to eat a clock?', 'It\'s very time consuming.'],
            ['My friend\'s bakery burned down last night.', 'Now his business is toast.'],
            ['Atheists don\'t solve exponential equations because they don\'t believe in higher powers.'],
            ['What kind of shorts do clouds wear?','Thunderwear!'],
            ['Becoming a vegetarian is a big missed steak.'],
            ['What do you call an alligator in a vest?','An investigator!'],
            ['How do you organize a space party?','You planet!'],
            ['Why did the banana go to the doctor?','It wasn\'t peeling well.'],
            ['What do you call a thieving alligator?','A crookodile!'],
            ['What do you call a pig that does karate?','Pork chop!'],
            ['What do you call a duck that steals?','A robber ducky!'],
            ['What did the traffic light say to the car?','Don\'t look, I\'m changing.']
        ];

        var potentiallyOffensiveJokes = [
            ['What do you call a cheap circumcision?', 'A rip-off'],
            'Don\'t let an extra chromosome get you down.',
            'Life is like toilet paper, you\'re either on a roll or taking shit from some asshole.',
            ['One day, a little boy wrote to Santa Clause.', 'Please send me a sister.', 'Santa Clause wrote him back.', 'Ok, send me your mother.'],
            ['Why can\'t Ken get Barbie pregnant?', 'because he comes in another box'],
            ['Did you hear about the gay security guard who got fired from his job at the sperm bank?', 'He got caught drinking on the job.'],
            ['What did the elephant say to the naked man?', 'How do you breathe through something so small?'],
            ['A man noticed that his credit card had been stolen but didn\'t report it.', 'The thief was spending less then his wife.'],
            ['Why is psychoanalysis quicker for men than for women?', 'When it\'s time to go back to his childhood, he\'s already there.'],
            ['What\'s the definition of trust?', 'Two cannibals giving each other a blowjob.'],
            ['Why is it difficult to find men who are sensitive, caring, and good looking?', 'They already have boyfriends.'],
            ['What\'s the difference between a new husband and a new dog.', 'After a year, the dog is still excited to see you.'],
            ['What has 2 grey legs and 2 brown legs?', 'An elephant with diarrhea.'],
            ['How do you know when a male porn star is at the gas station?', 'Right before the gas stops pumping he pulls out the nozzle and sprays it all over the car.'],
            ['Did you hear about the Easter egg hunt for the Alzheimer\'s patients?', 'They hid their own eggs!'],
            ['What should you give a man who has everything?', 'A woman to show him how to use it.'],
            ['What do you call an intelligent, good looking, sensitive man?', 'A rumor'],
            ['What do you call it when someone farts in a gay bar?', 'A love call.'],
            ['What did the pedophile say when he got out of jail?', 'I feel like a kid again!'],
            ['Why is air a lot like sex?', 'Because it\'s no big deal unless you\'re not getting any.'],
            ['What do spinach and anal sex have in common?', 'If you were forced to have it as a kid, you\'ll hate it as an adult.'],
            ['Abused women across the globe can unite over one thing.', 'Their lack of listening and cooking skills.'],
            ['What do feminists and blow up dolls have in common?', 'They are both incapable to shut their mouths.']
        ];

        var offensiveJokes = [
            ['Why did the music teacher get arrested?', 'He fingered A minor.'],
            ['What\'s the difference between a Gee Spot and a golf ball?', 'A guy will actually search for a golf ball.'],
            ['Why can\'t blondes count to 70?', 'Because 69 is a bit of a mouthful.'],
            ['What do the Mafia and a pussy have in common?', 'One slip of the tongue, and you\'re in deep shit.'],
            ['Three words to ruin a man\'s ego...?', 'Is it in?'],
            ['Why doesn\'t Santa have any kids?', 'He only comes once a year.'],
            ['Who can make more money in a week, a drug dealer or a prostitute?', 'The prostitute because she can wash and resell her crack.'],
            ['Why don\'t women have men\'s brains?' , 'Because they don\'t have penises to put them in.'],
            ['What\'s the difference between a bitch and a whore?', 'A whore sleeps with everybody at the party, and a bitch sleeps with everybody at the party except you.'],
            ['How can you make a gay man scream twice?', 'Fudge him real hard.', 'Then wipe your dick off on his curtains.'],
            ['Why do women prefer old gynecologists?', 'Their shaky hands!'],
            ['Men are like bank accounts.', 'Without a lot of money, they don\'t generate much interest.'],
            ['I was at a restaurant and I noticed my waitress had a black eye.', 'So I ordered very slowly because obviously she doesn\'t listen.'],
            ['My dad used to always warn me about anal.', 'He would say', 'Now son, this may hurt a bit.'],
            ['How do you get a nun pregnant?', 'Dress her up as an alter boy.'],
            ['Why do they call it PMS?', 'Because Mad Cow Disease was already taken.'],
            ['What\'s worse than getting raped by Jack the Ripper?', 'Getting fingered by Captain Hook.'],
            ['What do a walrus and Tupperware have in common?', 'They both like a tight seal.'],
            ['What did the banana say to the vibrator?', 'Why are you shaking?', 'She\'s going to eat me.'],
            ['Why haven\'t they sent a woman to the moon yet?', 'It doesn\'t need cleaning.'],
            ['Did you hear about the flasher who was thinking of retiring?', 'He decided to stick it out for one more year!'],
            ['What do a clitoris, an anniversary, and a toilet have in common?', 'Men always miss them.'],
            ['Why is the space between a woman\'s breasts and her hips called a waist?', 'Because you could easily fit another pair of tits in there.'],
            ['Why is sleeping with a man like a soap opera?', 'Just when it\'s getting interesting, they\'re finished until next time.'],
            ['Why does the bride always wear white?',  'Well... aren\'t all kitchen appliances that colour?'],
            ['Why do only 10% of women go to heaven?', 'Because if they all went, it would be hell.'],
            ['How many animals can you get into a pair of tights?', '10 little piggies, 2 calves, 1 beaver, 1 ass, 1 pussy, thousands of hares and a dead fish no one can ever find.'],
            ['Why does it take longer to build a blond snowman?', 'Because you have to hollow the head out.'],
            ['What did the boy vampire say to the girl vampire?', 'See you next period.'],
            ['What\'s the ultimate rejection?', 'When you\'re masturbating and your hand falls asleep.'],
            ['A wife is like a hand grenade.', 'Remove the ring, and your house is gone!'],
            ['A man runs over a woman. Whose fault is it?', 'The mans, because he shouldn\'t be driving in the kitchen.'],
            ['I told my girlfriend that she would look better with her hair back.', 'Unfortunately that\'s a mean thing to say to a cancer patient.'],
            ['How do we know Jesus wasn\'t jewish?', 'He wouldn\'t have died for our sins, he would\'ve died for the insurance money.']
        ];

        var programmingJokes = [
            ['Programming is like sex', 'One mistake and you have to support it for the rest of your life.'],
            ['What did the suicidal function say?', 'GOODBYE WORLD'],
            ['How many Computer Scientist students does it take to change a lightbulb?', 'None, that\'s a hardware problem.'],
            ['3 Errors walk into a bar.', 'The barman says.', 'normally I\'d Throw you all out, but tonight I\'ll make an Exception.'],
            ['Why was the statement scared.', 'while the comment was not?', 'Statements are executed.'],
            ['Whats the object-oriented way to become wealthy?', 'Inheritance'],
            ['What did the router say to the doctor?', 'It hurts when IP'],
            ['To understand what recursion is, you must first understand recursion.'],
            ['What do you call a model that does work for IT Companies?', 'A data model.']
        ];

        var mathJokes = [
            ['What is the deal with the circle', 'It\'s pointless!'],
            ['What happened to the plant in math class?', 'It grew square roots.'],
            ['How do you make seven an even number?', 'Take the s out!'],
            ['Why is a math book always unhappy?', 'Because it always has lots of problems.'],
            ['Why did I divide sin by tan?', 'Just cos.'],
            ['Where do math teachers go on vacation?', 'To Times Square.'],
            ['Why did the mutually exclusive events break up?', 'They had nothing in common.'],
            ['What is the difference between a mathematician and a philosopher?', 'The mathematician needs paper, pencil, and a trash bin for his work - the philosopher can do without the trash bin.'],
            ['How do you know when you\'ve reached your Math Professors voice-mail?', ' The message is "The number you have dialed is imaginary. Please, rotate your phone by 90 degrees and try again..."'],
            ['What did one math book say to the other?', ' Don\'t bother me I\'ve got my own problems!']
        ];

        var plankJokes = [
            ['20 left', 'Just joking'],
            ['3', ' 2', ' 1', ' 0', ' -1', ' -2', ' -3', ' -4', 'almost there!'],
            ['20 left', '30 left', '40 left', 'wait for it...', '50 left'],
            ['Hi! Plankan will end in.', '...', '...', 'soon!'],
            ['Syntax error', 'your computer will restart in 30 seconds']
        ];

        var dadJokes = [
            ['I gave all my dead batteries away today...', 'free of charge'],
                ['Yesterday a clown held a door open for me.', 'I thought it was a nice jester'],
                ['I heard there was a new store called moderation', 'They had everything in there'],
                ['I dreamed about drowning in an ocean of orange soda last night', 'It was just a fanta sea'],
                'The shovel was a ground breaking invention',
                ['I knew I shouldn\'t have ate that seafood', 'because now I\'m feeling a little... eel'],
                ['Someone said my clothes were gay.', 'I said "Yeah, they came out of the closet this morning."'],
                ['A man tried to sell me a coffin today', 'I told him that\'s the last thing I need'],
                'The best thing about elevator jokes is that they work on so many levels',
                'When my wife told me to stop impersonating a flamingo, I had to put my foot down',
                'My sea sickness comes in waves',
                ['I asked a frenchman if he played video games.', 'He said "WII"'],
                ['What\'s the difference between a hippo and a zippo?', 'One is really heavy, the other is a little lighter.'],
                ['Did you hear about the restaurant on the moon?', 'The food is great, but there\'s just no atmosphere.'],
                ['I have kleptomania', 'but when it gets bad, I take something for it'],
                ['Why was Santa\'s little helper feeling depressed?', 'Because he had low elf esteem'],
                ['To the man in the wheelchair that stole my camouflage jacket:', 'You can hide, but you can\'t run'],
                ['A ham sandwich walks into a bar and orders a beer.', 'Bartender says: "Sorry, we don\'t serve food here."'],
                ['I\'m on a whiskey diet', 'I\'ve lost four days already'],
                ['I said to the doctor, "Can you give me something for my liver?"', 'He gave me a pound of onions'],
                ['What\'s the difference between beer nuts and deer nuts?', 'Beer nuts are about 49 cents and deer nuts are just under a buck.'],
                ['A man said to me that he hadn\'t been to the toilet for two years.', 'I think he\'s full of shit'],
                ['I thought about going on an all almond diet.', 'But that\'s just nuts'],
                ['Doctor, you\'ve got to help me, I\'m addicted to Twitter.', 'Doctor responds: "I don\'t follow you"']
        ];

        var variants = {
            extreme5: {
                name: 'Extreme - 5 Minutes',
                parts: [
                    {
                        name: 'Prepare for plank',
                        hidden: true,
                        time: 6,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Hi! Plankan will start in.'
                            }
                        ]
                    },
                    {
                        name: 'Plank #1',
                        time: 62,
                        countdown: true,
                        tick: {start: -15, interval: 5},
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: enabledJokes
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Side plank or pause #1',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Ten left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #2',
                        time: 62,
                        countdown: true,
                        tick: {start: -15, interval: 5},
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: enabledJokes
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Side plank or pause #2',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Ten left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #3',
                        time: 62,
                        countdown: true,
                        tick: {start: -15, interval: 5},
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: enabledJokes
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Extra time',
                        time: 24,
                        countdown: true,
                        tick: {start: -20, interval: 5},
                        timeSounds: [
                            {
                                time: 1,
                                type: 'speak',
                                sound: 'Extra plank time!'
                            }
                        ]
                    },
                    {
                        name: 'Plank finished',
                        hidden: true,
                        time: 10,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Finished!'
                            },
                            {
                                time: 1,
                                type: 'speak',
                                sound: 'Great work!'
                            },
                            {
                                time: 3,
                                type: 'file',
                                sound: [
                                    {weight: 1, sound: 'FakeApplause.mp3'},
                                    {weight: 19, sound: 'SMALL_CROWD_APPLAUSE.mp3'}
                                ]
                            }
                        ]
                    }
                ]
            },
            extreme: {
                name: 'Extreme',
                parts: [
                    {
                        name: 'Prepare for plank',
                        hidden: true,
                        time: 6,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Hi! Plankan will start in.'
                            }
                        ]
                    },
                    {
                        name: 'Plank #1',
                        time: 62,
                        countdown: true,
                        tick: {start: -15, interval: 5},
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: enabledJokes
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Side plank or pause #1',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Ten left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #2',
                        time: 62,
                        countdown: true,
                        tick: {start: -15, interval: 5},
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: enabledJokes
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Side plank or pause #2',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Ten left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #3',
                        time: 62,
                        countdown: true,
                        tick: {start: -15, interval: 5},
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: enabledJokes
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank finished',
                        hidden: true,
                        time: 10,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Finished!'
                            },
                            {
                                time: 1,
                                type: 'speak',
                                sound: 'Great work!'
                            },
                            {
                                time: 3,
                                type: 'file',
                                sound: [
                                    {weight: 1, sound: 'FakeApplause.mp3'},
                                    {weight: 19, sound: 'SMALL_CROWD_APPLAUSE.mp3'}
                                ]
                            }
                        ]
                    }
                ]
            },
            classic: {
                name: 'Classic',
                parts: [
                    {
                        name: 'Prepare for plank',
                        hidden: true,
                        time: 6,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Hi! Plankan will start in.'
                            }
                        ]
                    },
                    {
                        name: 'Plank #1',
                        time: 60,
                        countdown: true,
                        tick: {start: -15, interval: 5},
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'First rest',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: enabledJokes
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Get ready!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #2',
                        time: 60,
                        countdown: true,
                        tick: {start: -15, interval: 5},
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Second rest',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: enabledJokes
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Get ready!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #3',
                        time: 60,
                        countdown: true,
                        tick: {start: -15, interval: 5},
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank finished',
                        hidden: true,
                        time: 10,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Finished!'
                            },
                            {
                                time: 1,
                                type: 'speak',
                                sound: 'Great work!'
                            },
                            {
                                time: 3,
                                type: 'file',
                                sound: 'FakeApplause.mp3'
                            }
                        ]
                    }
                ]
            }
        };

        function populateVariants() {
            var variantsSelect = document.querySelector('.plankan-variants');
            if (variantsSelect) {
                clearContainer(variantsSelect);
                var chooseOption = document.createElement('option');
                chooseOption.style.color = 'gray';
                chooseOption.value = '';
                chooseOption.innerHTML = 'Which planka can you manage?';
                variantsSelect.appendChild(chooseOption);
                for (var variant in variants) {
                    var variantOption = document.createElement('option');
                    variantOption.value = variant;
                    variantOption.innerHTML = variants[variant].name;
                    variantsSelect.appendChild(variantOption);
                }
            }
        }

        function preloadLastVariant() {
            var lastVariant = window.localStorage.getItem('lastSession');
            if (lastVariant) {
                var variantsSelect = document.querySelector('.plankan-variants');
                variantsSelect.value = lastVariant;
            }
        }

        function changedVariant() {
            displayVariantInfo();
            saveLastVariant();
        }

        function saveLastVariant() {
            var variantsSelect = document.querySelector('.plankan-variants');
            window.localStorage.setItem('lastSession', variantsSelect.value);
        }

        var allJokeTypes = [
            {name: "Clean Jokes", jokes: shortJokes, default: true},
            {name: "Dirty Jokes", jokes: potentiallyOffensiveJokes},
            {name: "Programming Jokes", jokes: programmingJokes},
            {name: "Math Jokes", jokes: mathJokes},
            {name: "Plank Jokes", jokes: plankJokes},
            {name: "Dad Jokes", jokes: dadJokes},
            {name: "Offensive Jokes", jokes: offensiveJokes}
        ];

        function initJokeTypes() {
            var wrapper = document.querySelector('.joketypes-wrapper');
            clearContainer(wrapper);

            var title = getTitle("Joke types");
            wrapper.appendChild(title);

            for (var i = 0; i < allJokeTypes.length; i++) {
                addJokeType(wrapper, allJokeTypes[i]);
            }

            loadJokeTypePreference();
        }

        function addJokeType(wrapper, type) {
            var checkboxId = 'check-' + type.name.replace(/\s/g, '_');

            var jokeTypeCheckbox = document.createElement('input');
            jokeTypeCheckbox.setAttribute('type', 'checkbox');
            jokeTypeCheckbox.setAttribute('data-name', type.name);
            if (type.default) {
                jokeTypeCheckbox.checked = true;
            }
            jokeTypeCheckbox.id = checkboxId;
            jokeTypeCheckbox.onchange = saveJokeTypePreference;

            var jokeTypeLabel = document.createElement('label');
            jokeTypeLabel.setAttribute('for', checkboxId);
            jokeTypeLabel.innerHTML = type.name;

            var jokeType = document.createElement('div');
            jokeType.className = 'joketype-wrapper';
            jokeType.appendChild(jokeTypeCheckbox);
            jokeType.appendChild(jokeTypeLabel);

            wrapper.appendChild(jokeType);
        }

        function saveJokeTypePreference() {
            var jokeTypes = document.querySelectorAll('.joketype-wrapper input[type="checkbox"]');
            var checkedNames = getCheckedJokeTypes(jokeTypes);
            if (!checkedNames.length) {
                jokeTypes[0].checked = true;
                saveJokeTypePreference();
                return;
            }
            window.localStorage.setItem('joketypes', checkedNames);
        }

        function getCheckedJokeTypes(jokeTypes) {
            var checkedNames = '';
            for (var i = 0; i < jokeTypes.length; i++) {
                if (jokeTypes[i].checked) {
                    checkedNames += (checkedNames.length ? ',': '') + jokeTypes[i].getAttribute('data-name');
                }
            }
            return checkedNames;
        }

        function loadJokeTypePreference() {
            var savedJokeTypePreference = window.localStorage.getItem('joketypes');
            if (savedJokeTypePreference) {
                // Uncheck all
                var allJokeTypes = document.querySelectorAll('.joketype-wrapper input[type="checkbox"]');
                var i;
                for (i = 0; i < allJokeTypes.length; i++) {
                    allJokeTypes[i].checked = false;
                }

                // Check the ones saved
                var splitted = savedJokeTypePreference.split(',');
                for (i = 0; i < splitted.length; i++) {
                    var jokeTypeToSelect = document.querySelector('.joketype-wrapper input[type="checkbox"][data-name="' + splitted[i] + '"]');
                    if (jokeTypeToSelect) {
                        jokeTypeToSelect.checked = true;
                    }
                }

                // Save, to make sure at least one is selected
                saveJokeTypePreference();
            }
        }

        function alignJokes() {
            var enabledJokeTypes = getCheckedJokeTypes(document.querySelectorAll('.joketype-wrapper input[type="checkbox"]'));
            var jokeLists = getJokeLists(enabledJokeTypes.split(','));

            // Clear list
            enabledJokes.length = 0;

            // Add one by one
            for (var i = 0; i < jokeLists.length; i++) {
                if (jokeLists[i].length) {
                    for (var j = 0; j < jokeLists[i].length; j++) {
                        enabledJokes.push(jokeLists[i][j]);
                    }
                }
            }
        }

        function getJokeLists(enabledTypes) {
            var jokeLists = [];
            for (var i = 0; i < allJokeTypes.length; i++) {
                if (enabledTypes.indexOf(allJokeTypes[i].name) !== -1) {
                    jokeLists.push(allJokeTypes[i].jokes);
                }
            }
            return jokeLists;
        }

        function start() {
            playSilence();
            populateVariants();
            preloadLastVariant();
            displayVariantInfo();
            initJokeTypes();
        }

        /* DOM creating, removing */
        function getTitle(title, level) {
            var titleObj = document.createElement(level || 'h3');
            titleObj.innerHTML = title;
            return titleObj;
        }

        function getSingleBulletContent(text, time) {
            var bulletObj = document.createElement('div');
            bulletObj.className = 'bullet';
            bulletObj.innerHTML = text;

            var bulletTimeObj = document.createElement('div');
            bulletTimeObj.className = 'bullet-time';
            bulletTimeObj.dataset.time = text;
            bulletTimeObj.innerHTML = time;
            bulletObj.appendChild(bulletTimeObj);

            return bulletObj;
        }

        function getPlankPart(partInfo) {
            var part = document.createElement('li');
            part.appendChild(getSingleBulletContent(partInfo.name, getTimeLabelForSeconds(partInfo.time)));
            return part;
        }

        function getProgressArea(type, label) {
            var progressArea = document.createElement('div');
            progressArea.className = 'progress-wrapper ' + type;

            var title = getTitle(label);
            var titleTime = document.createElement('span');
            titleTime.className = 'title-time ' + type;
            title.appendChild(titleTime);
            progressArea.appendChild(title);

            var progress = document.createElement('progress');
            progress.className = 'progressbar ' + type;
            progress.min = 0;
            progress.max = 100;

            progressArea.appendChild(progress);

            return progressArea;
        }

        function clearContainer(container) {
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
        }
        /* / DOM creating, removing*/

        function getTimeLabelForSeconds(time) {
            var minutes = time >= 60 ? (time - time % 60) / 60 : 0;
            var seconds = time % 60;
            return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        }

        function displayVariantInfo() {
            var variantsSelect = document.querySelector('.plankan-variants');
            var plankInfo = document.querySelector('.plank-info');
            clearContainer(plankInfo);
            if (variantsSelect.value in variants) {
                var variant = variants[variantsSelect.value];
                plankInfo.appendChild(getTitle(variant.name));
                var partBullets = document.createElement('ul');
                for (var i = 0; i < variant.parts.length; i++) {
                    var part = variant.parts[i];
                    if (!part.hidden) {
                        partBullets.appendChild(getPlankPart(part));
                    }
                }
                plankInfo.appendChild(partBullets);
                plankInfo.appendChild(getProgressArea('current', 'Current'));
                plankInfo.appendChild(getProgressArea('total', 'Total'));
            }
        }

        function sortByTime(o1, o2) {
            return o1.time - o2.time;
        }

        function addRelativePartToTimeline(timeline, absTime, partTime, soundPart, part) {
            var isNegative = soundPart.time === null || soundPart.time < 0;
            timeline.push({
                time: (absTime + (isNegative ? partTime + (soundPart.time === null ? 0 : soundPart.time) : soundPart.time)) * 1000,
                type: soundPart.type,
                sound: soundPart.sound,
                part: part,
                partStart: absTime * 1000
            });
        }

        function addTicksToTimeline(timeline, absTime, partTime, part, tickStart, tickInterval) {
            var isNegative = tickStart < 0;
            for (var i = isNegative ? partTime + tickStart : tickStart; i < partTime; i += tickInterval) {
                timeline.push({
                    time: (absTime + i) * 1000,
                    type: 'file',
                    sound: tickSound,
                    part: part,
                    partStart: absTime * 1000
                });
            }
        }

        function buildTimeline() {
            var timeline = [];
            var variantsSelect = document.querySelector('.plankan-variants');
            if (variantsSelect.value in variants) {
                currentVariant = variantsSelect.value;
                var variant = variants[variantsSelect.value];

                var accumulatedTime = 0;
                var part;
                var timeSound;
                var j;

                for (var i = 0; i < variant.parts.length; i++) {
                    part = variant.parts[i];
                    var partTime = part.time;

                    if (part.countdown) {
                        for (j = 0; j < countdownParts.length; j++) {
                            addRelativePartToTimeline(timeline, accumulatedTime, partTime, countdownParts[j], part);
                        }
                    }

                    for (j = 0; j < part.timeSounds.length; j++) {
                        addRelativePartToTimeline(timeline, accumulatedTime, partTime, part.timeSounds[j], part);
                    }

                    if (part.tick) {
                        var tickStart = part.tick.start || 0;
                        var tickInterval = part.tick.interval || 5;
                        addTicksToTimeline(timeline, accumulatedTime, partTime, part, tickStart, tickInterval);
                    }

                    accumulatedTime += partTime;
                }
            }
            timeline.sort(sortByTime);
            return timeline;
        }

        function getSound(files, type) {
            var sound = files;
            if (typeof files !== 'string') {
                var totalRandom = 0;
                var i;
                for (i = 0; i < files.length; i++) {
                    if (typeof files[i] !== 'string' && 'weight' in files[i]) {
                        totalRandom += files[i].weight;
                    } else {
                        totalRandom++;
                    }
                }

                while (true) {
                    var randomNumber = Math.floor(Math.random() * totalRandom);
                    var accRandom = 0;
                    for (i = 0; i < files.length; i++) {
                        accRandom += (typeof files[i] !== 'string' && 'weight' in files[i] ? files[i].weight : 1);
                        if (randomNumber < accRandom) {
                            sound = (typeof files[i] !== 'string' && 'sound' in files[i] ? files[i].sound : files[i]);
                            break;
                        }
                    }

                    if (type === 'file' || !isInRecentJokes(sound, totalRandom)) {
                        if (pickedRandomObjects.indexOf(sound) === -1) {
                            pickedRandomObjects.push(sound);
                            break;
                        }
                    }
                }
            }
            return sound;
        }

        var recentJokesCounters = [];
        function loadRecentJokesCounters() {
            var savedRecentJokes = window.localStorage.getItem('recentJokes');
            if (savedRecentJokes) {
                recentJokesCounters = JSON.parse(savedRecentJokes);
            }
        }

        function saveRecentJokesCounters() {
            window.localStorage.setItem('recentJokes', JSON.stringify(recentJokesCounters));
        }

        function decreaseRecentJokesCounters() {
            for (var i = 0; i < recentJokesCounters.length; i++) {
                if (--recentJokesCounters[i].count <= 0) {
                    recentJokesCounters.splice(i, 1);
                    i--;
                }
            }
        }

        function isInRecentJokes(joke, noReuseUntilCounter) {
            var isInRecentJokes = false;
            var jokeSHA = joke.hashCode();

            decreaseRecentJokesCounters();

            for (var i = 0; i < recentJokesCounters.length; i++) {
                if (recentJokesCounters[i].sha == jokeSHA) {
                    isInRecentJokes = true;
                    break;
                }
            }

            if (!isInRecentJokes) {
                recentJokesCounters.push({sha: jokeSHA, count: noReuseUntilCounter});
            }

            return isInRecentJokes;
        }

        function createHowl(sound) {
            return new Howl({
                urls: [sound],
                autoplay: false,
                loop: false,
                volume: 0.5
            });
        }

        function constructSoundQueue() {
            pickedRandomObjects.length = 0;
            for (var i = 0; i < sounds.length; i++) {
                if (sounds[i].type === 'file') {
                    var sound = getSound(sounds[i].sound, 'file');
                    sounds[i].sound = createHowl(sound);
                } else {
                    sounds[i].sound = getSound(sounds[i].sound, 'text');
                }
            }
        }

        var startTime = 0;
        var endTime = 0;
        var sounds = null;
        var queuedSound = null;
        var lastQueuedSound = null;
        var currentPart = null;
        var currentVariant = null;
        var pickedRandomObjects = [];
        function restartTimeoutChain() {
            endTime = 0;
            startTime = new Date().valueOf();
            setNextTime();
            startTimeout();
            updateAndStartClockTimeout();
        }

        function setNextTime() {
            var elapsed = new Date().valueOf() - startTime;
            console.log('Lookup next sound, time elapsed (s):', Math.floor(elapsed / 1000));
            var foundSound = false;
            for (var i = 0; i < sounds.length; i++) {
                var sound = sounds[i];
                if (!sound.passed) {
                    // This is our next action
                    var nextTime = sound.time;
                    sound.passed = true;
                    if (queuedSound) {
                        lastQueuedSound = queuedSound;
                    }
                    queuedSound = sound;
                    foundSound = true;
                    console.log('Next sound:', queuedSound, 'at time:', queuedSound.time);
                    break;
                }
            }
            if (!foundSound) {
                queuedSound = null;
            }
        }

        function startTimeout() {
            if (queuedSound) {
                var elapsed = new Date().valueOf() - startTime;
                var timeLeft = queuedSound.time - elapsed;
                if (timeLeft < 0) {
                    timeLeft = 0;
                }
                setTimeout(playQueuedAndProceed, timeLeft);
            } else {
                stopPlankan();
            }
        }

        function getTotalElapsedTime(elapsed) {
            var hiddenInStart = 0;
            var parts = variants[currentVariant].parts;
            for (var i = 0; i < parts.length; i++) {
                if (parts[i].hidden) {
                    hiddenInStart += parts[i].time;
                } else {
                    break;
                }
            }
            return Math.floor(elapsed / 1000) - hiddenInStart;
        }

        function getTotalTime() {
            var totalTime = 0;
            var parts = variants[currentVariant].parts;
            for (var i = 0; i < parts.length; i++) {
                if (!parts[i].hidden) {
                    totalTime += parts[i].time;
                }
            }
            return totalTime;
        }

        function getCurrentTimeProgressLabel(time, partTime) {
            return '▴ ' + getTimeLabelForSeconds(time) + ' ▾ ' + getTimeLabelForSeconds(partTime - time);
        }

        function updateProgress(elapsed, sound) {
            var currentTitleTime = document.querySelector('.title-time.current');
            var currentProgress = document.querySelector('.progressbar.current');

            var partTime = Math.floor((elapsed - sound.partStart) / 1000);
            currentTitleTime.innerHTML = getCurrentTimeProgressLabel(partTime, sound.part.time);
            currentProgress.max = sound.part.time;
            currentProgress.value = partTime;

            var totalTitleTime = document.querySelector('.title-time.total');
            var totalProgress = document.querySelector('.progressbar.total');
            var totalElapsedTime = getTotalElapsedTime(elapsed);
            var totalTime = getTotalTime();
            totalTitleTime.innerHTML = getCurrentTimeProgressLabel(totalElapsedTime, totalTime);
            totalProgress.max = totalTime;
            totalProgress.value = totalElapsedTime;
        }

        function updateAndStartClockTimeout() {
            var currentTime = new Date().valueOf();
            if (endTime && currentTime > endTime) {
                currentTime = endTime;
            }
            var elapsed = currentTime - startTime;

            if (queuedSound && !queuedSound.part.hidden) {
                updateProgress(elapsed, queuedSound);
            } else if (lastQueuedSound && !lastQueuedSound.part.hidden) {
                updateProgress(elapsed, lastQueuedSound);
            }


            if (!endTime) {
                setTimeout(updateAndStartClockTimeout, 1000 - elapsed % 1000);
            }
        }

        function playQueuedAndProceed() {
            var callback = function() {
                setNextTime();
                startTimeout();
            };
            var logDone = function() {
                console.log('Done');
            };

            if (queuedSound.type === 'speak') {
                // Speak
                speak(queuedSound.sound, logDone);
            } else {
                // Howl to play
                console.log('Play sound');
                queuedSound.sound.play(null, logDone);
            }
            callback();
        }

        function speak(text, callback) {
            console.log('Speak:', text);

            var speechInstance = new SpeechSynthesisUtterance();
            speechInstance.text = text;
            speechInstance.lang = 'en-US';

            if (isIOS()) {
                speechInstance.rate = 0.3;
            }

            speechInstance.onend = function () {
                if (callback) {
                    callback();
                }
            };

            speechInstance.onerror = function (e) {
                if (callback) {
                    console.error('Can\'t speak:', text, e);
                    callback(e);
                }
            };

            speechSynthesis.speak(speechInstance);
        }

        function stopPlankan() {
            endTime = new Date().valueOf();
            console.log(endTime - startTime);
        }

        function playSilence() {
            createHowl('silence.mp3').play(null, function() {
                console.log('Initiated sound of silence');
            });
        }

        function startPlankan() {
            alignJokes();
            loadRecentJokesCounters();
            sounds = buildTimeline();
            constructSoundQueue();
            saveRecentJokesCounters();
            restartTimeoutChain();
        }
    </script>
</head>
<body onload="start();">
<div class="container">
    <div class="header">Plankton 2.4 -- the "plankan" timer</div>

    <div class="plankan-chooser">
        <select class="plankan-variants" onchange="changedVariant()"></select>
    </div>

    <div class="plank-info">

    </div>

    <div class="joketypes-wrapper">

    </div>

    <input id="Start" type="button" value="Start plankan" class="start-button" onclick="startPlankan()" />
    <div class="footer">Be the plank!</div>
    <a href="http://jsfiddle.net/c38okrs4/12/"></a>
</div>
</body>
</html>
