<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Plankan timer</title>

    <style type="text/css">
        .bullet {
            position: relative;
        }

        .bullet-time {
            position: absolute;
            top: 0;
            right: 20px;
        }

        .title-time {
            margin-left: 1em;
            color: green;
        }

        .progress-wrapper {
            margin: 1em;
        }

        .progressbar {
            display: -webkit-box;
            -webkit-box-sizing: border-box;
            width: 100%;
        }

        .progressbar {
            display: -webkit-box;
            -webkit-box-sizing: border-box;
            width: 100%;
            height: 20px;
            margin: 0;
            background: none;
            border: 0;
            border-radius: 15px;
            position: relative;
        }

        .progressbar::-webkit-progress-bar {
            height: 11px;
            width: 100%;
            margin: 0 auto;
            background-color: #CCC;
            border-radius: 15px;
            box-shadow: 0 0 6px #777 inset;
        }

        .progressbar::-webkit-progress-value {
            display: inline-block;
            float: left;
            height: 11px;
            margin: 0 -10px 0 0;
            background: #F70;
            border-radius: 15px;
            box-shadow: 0 0 6px #777 inset;
        }

        .progressbar.total::-webkit-progress-value {
            background: #0C0;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="plankton.css">

    <script type="text/javascript" src="howler.js/howler.min.js"></script>
    <script type="text/javascript">
        var countdownParts = [
            {
                time: -3,
                type: 'speak',
                sound: 'Three!'
            },
            {
                time: -2,
                type: 'speak',
                sound: 'Two!'
            },
            {
                time: -1,
                type: 'speak',
                sound: 'One!'
            },
            // TODO - Speak: Start or Change?
            {
                time: null,
                type: 'file',
                sound: 'Intercom-beep-sound.mp3'
            }
        ];

        var cheerfulPhrases = [
            'Keep on!', 'Good work!', 'Be strong!', 'Live long and prosper.', 'All is well.', 'Remain cheerful!',
            'Be positive.', 'Stay happy', 'Hakuna matata!', 'The greatest wealth is health.', 'Eat right, exercise regularly',
            'Health is happiness.', 'A good laugh and a long sleep are the best cures in the doctor\'s book.', 'Boom, shackalacka, boom!',
            'Be yourself', 'Alive and kicking.', 'Refuse to lose.', 'Attitude is everything.', 'Don\'t worry, be happy.',
            'Yes you can.', 'No worries.', 'Get the ball rolling.', 'No guts, no glory.', 'Impossible is nothing.', 'Impossibru', 'Play hard or go home.',
            'Success is the only option.'];

        var shortJokes = [
            ['What happens to a frog\'s car when it breaks down?', 'It gets toad away.'],
            ['What is the difference between snowmen and snowwomen?', 'Snowballs.'],
            'I never wanted to believe that my Dad was stealing from his job as a road worker. But when I got home, all the signs were there.',
            ['How do astronomers organize a party?', 'They planet.'],
            ['What did the blanket say when it fell of the bed?', 'Oh sheet!'],
            ['Can a kangaroo jump higher than the Empire State Building?', 'Of course. The Empire State Building can\'t jump.'],
            'If you ever get cold, just stand in the corner of a room for a while. They\'re normally around 90 degrees.',
            ['What is Mozart doing right now?', 'Decomposing.'],
            'A drunk walks into a bar with jumper cables around his neck. The bartender says, "You can stay but don\'t try to start anything."',
            ['What’s the best thing about Switzerland?', 'I don\'t know, but the flag is a big plus.'],
            ['Two men broke into a drugstore and stole all the Viagra.', 'The police put out an alert to be on the lookout for the two hardened criminals.'],
            ['How do you embarrass an archaeologist? Show him a used tampon and ask, "What period is this from?"'],
            ['What kind of car does Jesus drive?', 'A Christ-leur.'], // Modified text
            ['What do you call a midget psychic who just escaped from prison?', 'A small medium at large.'],
            ['A neutron walks into a bar and says', 'I\'d like a beer. How much will that be?', 'The bartender responds', 'For you? No charge!'],
            ['To the optimist, the glass is half full.', 'To the pessimist, the glass is half empty.', 'To the engineer, the glass is twice as big as it needs to be.'],
            ['What\'s the difference between America and yogurt?', 'If you leave yogurt alone for 200 years, it develops a culture.'],
            ['What did the spider do on the computer?', 'Made a website!'],
            ['What do you get when you cross a donkey and an onion?', 'A piece of ass that\'ll bring a tear to your eye.'],
            ['What did the pony say when he had a sore throat?', 'Sorry, I\'m a little horse.'],
            ['What do you call someone without a nose or a body?', 'Nobody nose.'],
            ['Why did the music teacher get arrested?', 'He fingered A minor.'],
            ['Why did the condom fly across the room?', 'Because it was pissed off.'],
            ['What do you give a deaf fisherman?', 'A herring aid.'],
            ['What do the starship Enterprise and toilet paper have in common?', 'They both probe Uranus and wipe out Klingons.']
        ];

        var variants = {
            extreme: {
                name: 'Extreme',
                tick: false, // TODO - Implement this - if true, will tick every x seconds (unless sound adjacent within 2 seconds)
                background: false, // TODO - Do we really need background sound?
                parts: [
                    {
                        name: 'Prepare for plank',
                        hidden: true,
                        time: 6,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Hi! Plankan will start in.'
                            }
                        ]
                    },
                    {
                        name: 'Plank #1',
                        time: 62,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: shortJokes
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Side plank or pause #1',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Ten left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #2',
                        time: 62,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: shortJokes
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Side plank or pause #2',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Ten left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #3',
                        time: 62,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: shortJokes
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank finished',
                        hidden: true,
                        time: 10,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Finished!'
                            },
                            {
                                time: 1,
                                type: 'speak',
                                sound: 'Great work!'
                            },
                            {
                                time: 3,
                                type: 'file',
                                sound: [
                                    {weight: 1, sound: 'FakeApplause.mp3'},
                                    {weight: 19, sound: 'SMALL_CROWD_APPLAUSE.mp3'}
                                ]
                            }
                        ]
                    }
                ]
            },
            classic: {
                name: 'Classic',
                tick: false, // TODO - Implement this - if true, will tick every x seconds (unless sound adjacent within 2 seconds)
                background: false, // TODO - Do we really need background sound?
                parts: [
                    {
                        name: 'Prepare for plank',
                        hidden: true,
                        time: 6,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Hi! Plankan will start in.'
                            }
                        ]
                    },
                    {
                        name: 'Plank #1',
                        time: 60,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'First rest',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: shortJokes
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Get ready!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #2',
                        time: 60,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Second rest',
                        time: 45,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 10,
                                type: 'speak',
                                sound: shortJokes
                            },
                            {
                                time: -10,
                                type: 'speak',
                                sound: 'Get ready!'
                            }
                        ]
                    },
                    {
                        name: 'Plank #3',
                        time: 60,
                        countdown: true,
                        timeSounds: [
                            {
                                time: 20,
                                type: 'speak',
                                sound: cheerfulPhrases
                            },
                            {
                                time: -20,
                                type: 'speak',
                                sound: 'Twenty left!'
                            }
                        ]
                    },
                    {
                        name: 'Plank finished',
                        hidden: true,
                        time: 10,
                        timeSounds: [
                            {
                                time: 0,
                                type: 'speak',
                                sound: 'Finished!'
                            },
                            {
                                time: 1,
                                type: 'speak',
                                sound: 'Great work!'
                            },
                            {
                                time: 3,
                                type: 'file',
                                sound: 'FakeApplause.mp3'
                            }
                        ]
                    }
                ]
            }
        };

        function populateVariants() {
            var variantsSelect = document.querySelector('.plankan-variants');
            if (variantsSelect) {
                clearContainer(variantsSelect);
                var chooseOption = document.createElement('option');
                chooseOption.style.color = 'gray';
                chooseOption.value = '';
                chooseOption.innerHTML = 'Which planka can you manage?';
                variantsSelect.appendChild(chooseOption);
                for (var variant in variants) {
                    var variantOption = document.createElement('option');
                    variantOption.value = variant;
                    variantOption.innerHTML = variants[variant].name;
                    variantsSelect.appendChild(variantOption);
                }
            }
        }

        function preloadLastVariant() {
            var lastVariant = window.localStorage.getItem('lastSession');
            if (lastVariant) {
                var variantsSelect = document.querySelector('.plankan-variants');
                variantsSelect.value = lastVariant;
            }
        }

        function changedVariant() {
            displayVariantInfo();
            saveLastVariant();
        }

        function saveLastVariant() {
            var variantsSelect = document.querySelector('.plankan-variants');
            window.localStorage.setItem('lastSession', variantsSelect.value);
        }

        function start() {
            populateVariants();
            preloadLastVariant();
            displayVariantInfo();
        }

        /* DOM creating, removing */
        function getTitle(title, level) {
            var titleObj = document.createElement(level || 'h3');
            titleObj.innerHTML = title;
            return titleObj;
        }

        function getSingleBulletContent(text, time) {
            var bulletObj = document.createElement('div');
            bulletObj.className = 'bullet';
            bulletObj.innerHTML = text;

            var bulletTimeObj = document.createElement('div');
            bulletTimeObj.className = 'bullet-time';
            bulletTimeObj.dataset.time = text;
            bulletTimeObj.innerHTML = time;
            bulletObj.appendChild(bulletTimeObj);

            return bulletObj;
        }

        function getPlankPart(partInfo) {
            var part = document.createElement('li');
            part.appendChild(getSingleBulletContent(partInfo.name, getTimeLabelForSeconds(partInfo.time)));
            return part;
        }

        function getProgressArea(type, label) {
            var progressArea = document.createElement('div');
            progressArea.className = 'progress-wrapper ' + type;

            var title = getTitle(label);
            var titleTime = document.createElement('span');
            titleTime.className = 'title-time ' + type;
            title.appendChild(titleTime);
            progressArea.appendChild(title);

            var progress = document.createElement('progress');
            progress.className = 'progressbar ' + type;
            progress.min = 0;
            progress.max = 100;

            progressArea.appendChild(progress);

            return progressArea;
        }

        function clearContainer(container) {
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
        }
        /* / DOM creating, removing*/

        function getTimeLabelForSeconds(time) {
            var minutes = time >= 60 ? (time - time % 60) / 60 : 0;
            var seconds = time % 60;
            return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        }

        function displayVariantInfo() {
            var variantsSelect = document.querySelector('.plankan-variants');
            var plankInfo = document.querySelector('.plank-info');
            clearContainer(plankInfo);
            if (variantsSelect.value in variants) {
                var variant = variants[variantsSelect.value];
                plankInfo.appendChild(getTitle(variant.name));
                var partBullets = document.createElement('ul');
                for (var i = 0; i < variant.parts.length; i++) {
                    var part = variant.parts[i];
                    if (!part.hidden) {
                        partBullets.appendChild(getPlankPart(part));
                    }
                }
                plankInfo.appendChild(partBullets);
                plankInfo.appendChild(getProgressArea('current', 'Current'));
                plankInfo.appendChild(getProgressArea('total', 'Total'));
            }
        }

        function sortByTime(o1, o2) {
            return o1.time - o2.time;
        }

        function addRelativePartToTimeline(timeline, absTime, partTime, soundPart, part) {
            var isNegative = soundPart.time === null || soundPart.time < 0;
            timeline.push({
                time: (absTime + (isNegative ? partTime + (soundPart.time === null ? 0 : soundPart.time) : soundPart.time)) * 1000,
                type: soundPart.type,
                sound: soundPart.sound,
                part: part,
                partStart: absTime * 1000
            });
        }

        function buildTimeline() {
            var timeline = [];
            var variantsSelect = document.querySelector('.plankan-variants');
            if (variantsSelect.value in variants) {
                currentVariant = variantsSelect.value;
                var variant = variants[variantsSelect.value];

                var accumulatedTime = 0;
                var part;
                var timeSound;
                var j;

                for (var i = 0; i < variant.parts.length; i++) {
                    part = variant.parts[i];
                    var partTime = part.time;

                    if (part.countdown) {
                        for (j = 0; j < countdownParts.length; j++) {
                            addRelativePartToTimeline(timeline, accumulatedTime, partTime, countdownParts[j], part);
                        }
                    }

                    for (j = 0; j < part.timeSounds.length; j++) {
                        addRelativePartToTimeline(timeline, accumulatedTime, partTime, part.timeSounds[j], part);
                    }

                    accumulatedTime += partTime;
                }
            }
            timeline.sort(sortByTime);
            return timeline;
        }

        function getSound(files) {
            var soundFile = files;
            if (typeof files !== 'string') {
                var totalRandom = 0;
                var i;
                for (i = 0; i < files.length; i++) {
                    if (typeof files[i] !== 'string' && 'weight' in files[i]) {
                        totalRandom += files[i].weight;
                    } else {
                        totalRandom++;
                    }
                }

                var randomNumber = Math.floor(Math.random() * totalRandom);
                var accRandom = 0;
                for (i = 0; i < files.length; i++) {
                    accRandom += (typeof files[i] !== 'string' && 'weight' in files[i] ? files[i].weight : 1);
                    if (randomNumber < accRandom) {
                        soundFile = (typeof files[i] !== 'string' && 'sound' in files[i] ? files[i].sound : files[i]);
                        break;
                    }
                }
            }
            return soundFile;
        }

        function createHowl(sound) {
            return new Howl({
                urls: [sound],
                autoplay: false,
                loop: false,
                volume: 0.5
            });
        }

        function constructSoundQueue() {
            for (var i = 0; i < sounds.length; i++) {
                if (sounds[i].type === 'file') {
                    var sound = getSound(sounds[i].sound);
                    sounds[i].sound = createHowl(sound);
                } else {
                    sounds[i].sound = getSound(sounds[i].sound);
                }
            }
        }

        var startTime = 0;
        var endTime = 0;
        var sounds = null;
        var queuedSound = null;
        var currentPart = null;
        var currentVariant = null;
        function restartTimeoutChain() {
            endTime = 0;
            startTime = new Date().valueOf();
            setNextTime();
            startTimeout();
            updateAndStartClockTimeout();
        }

        function setNextTime() {
            var elapsed = new Date().valueOf() - startTime;
            console.log('Lookup next sound, time elapsed (s):', Math.floor(elapsed / 1000));
            var foundSound = false;
            for (var i = 0; i < sounds.length; i++) {
                var sound = sounds[i];
                if (!sound.passed) {
                    // This is our next action
                    var nextTime = sound.time;
                    sound.passed = true;
                    queuedSound = sound;
                    foundSound = true;
                    console.log('Next sound:', queuedSound, 'at time:', queuedSound.time);
                    break;
                }
            }
            if (!foundSound) {
                queuedSound = null;
            }
        }

        function startTimeout() {
            if (queuedSound) {
                var elapsed = new Date().valueOf() - startTime;
                var timeLeft = queuedSound.time - elapsed;
                if (timeLeft < 0) {
                    timeLeft = 0;
                }
                setTimeout(playQueuedAndProceed, timeLeft);
            } else {
                stopPlankan();
            }
        }

        function getTotalElapsedTime(elapsed) {
            var hiddenInStart = 0;
            var parts = variants[currentVariant].parts;
            for (var i = 0; i < parts.length; i++) {
                if (parts[i].hidden) {
                    hiddenInStart += parts[i].time;
                } else {
                    break;
                }
            }
            return Math.floor(elapsed / 1000) - hiddenInStart;
        }

        function getTotalTime() {
            var totalTime = 0;
            var parts = variants[currentVariant].parts;
            for (var i = 0; i < parts.length; i++) {
                if (!parts[i].hidden) {
                    totalTime += parts[i].time;
                }
            }
            return totalTime;
        }

        function getCurrentTimeProgressLabel(time, partTime) {
            return '▴ ' + getTimeLabelForSeconds(time) + ' ▾ ' + getTimeLabelForSeconds(partTime - time);
        }

        function updateAndStartClockTimeout() {
            var currentTime = new Date().valueOf();
            if (endTime && currentTime > endTime) {
                currentTime = endTime;
            }
            var elapsed = currentTime - startTime;

            if (!queuedSound.part.hidden) {
                var currentTitleTime = document.querySelector('.title-time.current');
                var currentProgress = document.querySelector('.progressbar.current');

                var partTime = Math.floor((elapsed - queuedSound.partStart) / 1000);
                currentTitleTime.innerHTML = getCurrentTimeProgressLabel(partTime, queuedSound.part.time);
                currentProgress.max = queuedSound.part.time;
                currentProgress.value = partTime;

                var totalTitleTime = document.querySelector('.title-time.total');
                var totalProgress = document.querySelector('.progressbar.total');
                var totalElapsedTime = getTotalElapsedTime(elapsed);
                var totalTime = getTotalTime();
                totalTitleTime.innerHTML = getCurrentTimeProgressLabel(totalElapsedTime, totalTime);
                totalProgress.max = totalTime;
                totalProgress.value = totalElapsedTime;
            }

            if (!endTime) {
                setTimeout(updateAndStartClockTimeout, 1000 - elapsed % 1000);
            }
        }

        function playQueuedAndProceed() {
            var callback = function() {
                setNextTime();
                startTimeout();
            };
            var logDone = function() {
                console.log('Done');
            };

            if (queuedSound.type === 'speak') {
                // Speak
                speak(queuedSound.sound, logDone);
            } else {
                // Howl to play
                console.log('Play sound');
                queuedSound.sound.play(null, logDone);
            }
            callback();
        }

        function speak(text, callback) {
            console.log('Speak:', text);

            var speechInstance = new SpeechSynthesisUtterance();
            speechInstance.text = text;
            speechInstance.lang = 'en-US';

            speechInstance.onend = function () {
                if (callback) {
                    callback();
                }
            };

            speechInstance.onerror = function (e) {
                if (callback) {
                    console.error('Can\'t speak:', text, e);
                    callback(e);
                }
            };

            speechSynthesis.speak(speechInstance);
        }

        function stopPlankan() {
            endTime = new Date.valueOf();
            console.log(endTime - startTime);
        }

        function startPlankan() {
            sounds = buildTimeline();
            constructSoundQueue();
            restartTimeoutChain();
        }
    </script>
</head>
<body onload="start();">
<div class="container">
    <div class="header-2">Plankton 2.0 -- the "plankan" timer</div>

    <div class="plankan-chooser">
        <select class="plankan-variants" onchange="changedVariant()"></select>
    </div>

    <div class="plank-info">

    </div>

    <input id="Start" type="button" value="Start plankan" class="start-button" onclick="startPlankan()" />
    <div class="footer-2">Be the plank!</div>
    <a href="http://jsfiddle.net/c38okrs4/12/"></a>
</div>
</body>
</html>