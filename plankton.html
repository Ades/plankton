<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Plankan timer</title>

    <style type="text/css">
        .box {
            display: -webkit-box;
        }
        .box div:first-child {
            -webkit-box-flex: 1;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="plankton.css">

    <script type="text/javascript" src="howler.js/howler.min.js"></script>
    <script type="text/javascript">
        var timers = [];

        function addTimer(timerID, callback, timeTimeAt) {
            timerElement = timers.push({element:document.getElementById(timerID), callback: callback, time:!!timeTimeAt?timeTimeAt:0});
            timerElement.innerHTML = 0;
        }
        function stopLast(timerID) {
            timerElement = timers.pop();
        }
        function tick() {
            for (var i = 0 ; i < timers.length; i++) {
                timers[i].time+=1;
                if (timers[i].time >= 0) {
                    var element = timers[i].element;
                    var time = timers[i].time;
                    var minutes = Math.floor(time / 60);
                    minutes = (minutes < 10 ? '0' : '') + minutes;
                    var seconds = time % 60;
                    seconds = (seconds < 10 ? '0' : '') + seconds;
                    element.innerHTML = minutes + ':' + seconds;
                    if (timers[i].callback) {
                        timers[i].callback();
                    }
                    timers[i].callback = undefined;
                }
            }
            console.log('tick');
            window.setTimeout("tick()", 1000);
        }
        tick();

        function getCheerfulPhrase() {
            var phrases = ['Keep on!', 'Good work!', 'Be strong!', 'Live long and prosper.', 'All is well.', 'Remain cheerful!',
            'Be positive.', ' Stay happy', 'Hakuna matata!', 'The greatest wealth is health.', 'Eat right, exercise regularly',
            'Health is happiness.', 'A good laugh and a long sleep are the best cures in the doctor\'s book.', 'Boom, shackalacka, boom!',
            'Be yourself', 'Alive and kicking.', 'Refuse to lose.', 'Attitude is everything.', 'Don\'t worry, be happy.',
            'Yes you can.', 'No worries.', 'Get the ball rolling.', 'No guts, no glory.', 'Impossible is nothing.', 'Impossibru', 'Play hard or go home.',
            'Success is the only option.'];
            var i = Math.trunc(phrases.length * Math.random());
            return phrases[i];
        }

        function speak(text, callback) {
            var u = new SpeechSynthesisUtterance();
            u.text = text;
            u.lang = 'en-US';

            u.onend = function () {
                if (callback) {
                    callback();
                }
            };

            u.onerror = function (e) {
                if (callback) {
                    callback(e);
                }
            };

            speechSynthesis.speak(u);
        }

        function speakAt(inSeconds, text, callback) {
            setTimeout(function () {
                speak(text, callback)
            }, inSeconds * 1000);
        }

        function startPlankan() {
            var sound = new Howl({
                urls: ['Intercom-beep-sound.mp3']
            });
            var backgroundSound = new Howl({
                urls: document.querySelector('#sound-checkbox').checked ? ['http://goldfirestudios.com/proj/howlerjs/sound.ogg'] : ['output.ogg'],
                autoplay: false,
                loop: true,
                volume: 0.5
            });
            var backgroundSoundRelax = new Howl({
                urls: ['output.ogg'],
                autoplay: false,
                loop: true,
                volume: 0.2
            });
            var applause = new Howl({
                urls: Math.random() > 0.05 ? ['SMALL_CROWD_APPLAUSE.mp3'] : ['FakeApplause.mp3'],
                autoplay: false,
                loop: false,
                volume: 0.2
            });

            var t = 0;
            var BACKGROUND_VOLUME = 0.1;

            speakAt(t+=0, "Hi! Plankan will start in.", function () {backgroundSoundRelax.pause().fadeIn(BACKGROUND_VOLUME, 4000);});
            speakAt(t+=1, "Three");
            speakAt(t+=1, "Two");
            speakAt(t+=1, "One");
            speakAt(t+=1, "Start!", function () {addTimer('timer');addTimer('timer1');sound.play();backgroundSound.pause().fadeIn(BACKGROUND_VOLUME, 4000);});
            speakAt(t+=40, "Twenty left!");
            speakAt(t+=19, "Three!", function () {backgroundSound.pause().fadeOut(0, 2000);});
            speakAt(t+=1, "Two!");
            speakAt(t+=1, "One!");
            speakAt(t+=1, "Change!", function () {stopLast('timer1');});

            speakAt(t+=1, "Start side plank!",function () {addTimer('timer2');sound.play();});
            speakAt(t+=10, "Good work!");
            speakAt(t+=10, getCheerfulPhrase());
            speakAt(t+=15, "Ten left!");
            speakAt(t+=8, "Three!");
            speakAt(t+=1, "Two!");
            speakAt(t+=1, "One!");
            speakAt(t+=1, "Change!", function () {stopLast('timer2');});

            speakAt(t+=1, "Start plank!", function () {addTimer('timer3');sound.play();backgroundSound.pause().fadeIn(BACKGROUND_VOLUME, 4000);});
            speakAt(t+=40, "Twenty left!");
            speakAt(t+=19, "Three!", function () {backgroundSound.pause().fadeOut(0, 2000);});
            speakAt(t+=1, "Two!");
            speakAt(t+=1, "One!");
            speakAt(t+=1, "Change!", function () {stopLast('timer3');});

            speakAt(t+=1, "Start side plank!", function () {addTimer('timer4');sound.play();});
            speakAt(t+=20, "Good work!");
            speakAt(t+=15, "Ten left!");
            speakAt(t+=8, "Three!");
            speakAt(t+=1, "Two!");
            speakAt(t+=1, "One!");
            speakAt(t+=1, "Change!", function () {stopLast('timer4');});

            speakAt(t+=1, "Start plank!", function () {addTimer('timer5');sound.play();backgroundSound.pause().fadeIn(BACKGROUND_VOLUME, 4000);});
            speakAt(t+=40, "Twenty left!");
            speakAt(t+=19, "Three!", function () {backgroundSound.pause().fadeOut(0, 2000);});
            speakAt(t+=1, "Two!");
            speakAt(t+=1, "One!");
            speakAt(t+=1, "Finished!", function () {stopLast('timer5');stopLast('timer');});
            speakAt(t+=2, "Great work!", function () {applause.play();backgroundSoundRelax.pause().fadeOut(0, 1000);});

        }
</script>
</head>
<body>
    <div class="container">
        <div class="header">Plankton -- the "plankan" timer</div>
        <div class="mainbody">
            <div class="box"><div>1 min</div><div id="timer1"></div></div>
            <div class="box"><div>45s side plank or pause</div><div id="timer2"></div></div>
            <div class="box"><div>1 min</div><div id="timer3"></div></div>
            <div class="box"><div>45s side plank or pause</div><div id="timer4"></div></div>
            <div class="box"><div>1 min</div><div id="timer5"></div></div>
        </div>
        <div id="timer">00:00</div>
        <input id="Start" type="button" value="Start plankan" onclick="startPlankan()" />
        <input id="sound-checkbox" type="checkbox">Sound</input>
        <div class="footer">Be the plank!</div>
        <a href="http://jsfiddle.net/c38okrs4/12/"/>
    </div>
</body>
</html>